<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Botonera de Sonidos</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="dark-mode-toggle">
      <label class="switch">
        <input type="checkbox" id="darkModeToggle" />
        <span class="slider"></span>
      </label>
      <span class="toggle-label">Modo Oscuro</span>
    </div>

    <div class="container">
      <h1>ğŸ”Š Botonera de Mimorcito</h1>

      <h2>Efectos de Sonido</h2>
      <div class="sound-grid">
        <div class="sound-item">
          <button class="sound-button" data-sound="1">ğŸº Aullido lobo</button>
          <div class="volume-control">
            <span class="volume-label">ğŸ”Š</span>
            <input
              type="range"
              class="volume-slider"
              min="0"
              max="100"
              value="100"
              data-sound="1"
            />
            <span class="volume-value">100%</span>
          </div>
        </div>

        <div class="sound-item">
          <button class="sound-button" data-sound="2">ğŸšª Puerta abre</button>
          <div class="volume-control">
            <span class="volume-label">ğŸ”Š</span>
            <input
              type="range"
              class="volume-slider"
              min="0"
              max="100"
              value="100"
              data-sound="2"
            />
            <span class="volume-value">100%</span>
          </div>
        </div>

        <div class="sound-item">
          <button class="sound-button" data-sound="3">ğŸšª Puerta cierra</button>
          <div class="volume-control">
            <span class="volume-label">ğŸ”Š</span>
            <input
              type="range"
              class="volume-slider"
              min="0"
              max="100"
              value="100"
              data-sound="3"
            />
            <span class="volume-value">100%</span>
          </div>
        </div>

        <div class="sound-item">
          <button class="sound-button" data-sound="4">ğŸ”¥ Fosforo</button>
          <div class="volume-control">
            <span class="volume-label">ğŸ”Š</span>
            <input
              type="range"
              class="volume-slider"
              min="0"
              max="100"
              value="100"
              data-sound="4"
            />
            <span class="volume-value">100%</span>
          </div>
        </div>

        <div class="sound-item">
          <button class="sound-button" data-sound="5">ğŸ´ Carruaje</button>
          <div class="volume-control">
            <span class="volume-label">ğŸ”Š</span>
            <input
              type="range"
              class="volume-slider"
              min="0"
              max="100"
              value="100"
              data-sound="5"
            />
            <span class="volume-value">100%</span>
          </div>
        </div>

        <div class="sound-item">
          <button class="sound-button" data-sound="6">ğŸ˜­ Llanto</button>
          <div class="volume-control">
            <span class="volume-label">ğŸ”Š</span>
            <input
              type="range"
              class="volume-slider"
              min="0"
              max="100"
              value="100"
              data-sound="6"
            />
            <span class="volume-value">100%</span>
          </div>
        </div>

        <div class="sound-item">
          <button class="sound-button" data-sound="7">
            ğŸ¤¥Transformacion Pinocho
          </button>
          <div class="volume-control">
            <span class="volume-label">ğŸ”Š</span>
            <input
              type="range"
              class="volume-slider"
              min="0"
              max="100"
              value="100"
              data-sound="7"
            />
            <span class="volume-value">100%</span>
          </div>
        </div>

        <div class="sound-item">
          <button class="sound-button" data-sound="8">
            ğŸªµ Arrastra Pinocho
          </button>
          <div class="volume-control">
            <span class="volume-label">ğŸ”Š</span>
            <input
              type="range"
              class="volume-slider"
              min="0"
              max="100"
              value="100"
              data-sound="8"
            />
            <span class="volume-value">100%</span>
          </div>
        </div>

        <div class="sound-item">
          <button class="sound-button" data-sound="9">ğŸªµ Mueve madera</button>
          <div class="volume-control">
            <span class="volume-label">ğŸ”Š</span>
            <input
              type="range"
              class="volume-slider"
              min="0"
              max="100"
              value="100"
              data-sound="9"
            />
            <span class="volume-value">100%</span>
          </div>
        </div>

        <div class="sound-item">
          <button class="sound-button" data-sound="10">ğŸ§¹ Escoba</button>
          <div class="volume-control">
            <span class="volume-label">ğŸ”Š</span>
            <input
              type="range"
              class="volume-slider"
              min="0"
              max="100"
              value="100"
              data-sound="10"
            />
            <span class="volume-value">100%</span>
          </div>
        </div>

        <div class="sound-item">
          <button class="sound-button" data-sound="11">ğŸƒ Escape</button>
          <div class="volume-control">
            <span class="volume-label">ğŸ”Š</span>
            <input
              type="range"
              class="volume-slider"
              min="0"
              max="100"
              value="100"
              data-sound="11"
            />
            <span class="volume-value">100%</span>
          </div>
        </div>

        <div class="sound-item">
          <button class="sound-button" data-sound="12">ğŸ‘ Aplausos</button>
          <div class="volume-control">
            <span class="volume-label">ğŸ”Š</span>
            <input
              type="range"
              class="volume-slider"
              min="0"
              max="100"
              value="100"
              data-sound="12"
            />
            <span class="volume-value">100%</span>
          </div>
        </div>
      </div>

      <h2>ğŸµ MÃºsica Ambiente</h2>
      <div class="ambient-section">
        <div class="ambient-tracks">
          <div class="ambient-track">
            <div class="track-name">Pista 1</div>
            <div class="track-controls">
              <button class="play-button" data-track="1">â–¶</button>
              <div class="track-volume">
                <span>ğŸ”Š</span>
                <input
                  type="range"
                  class="track-volume-slider"
                  min="0"
                  max="100"
                  value="50"
                  data-track="1"
                />
                <span class="volume-value">50%</span>
              </div>
            </div>
          </div>

          <div class="ambient-track">
            <div class="track-name">Pista 2</div>
            <div class="track-controls">
              <button class="play-button" data-track="2">â–¶</button>
              <div class="track-volume">
                <span>ğŸ”Š</span>
                <input
                  type="range"
                  class="track-volume-slider"
                  min="0"
                  max="100"
                  value="50"
                  data-track="2"
                />
                <span class="volume-value">50%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // === MODO OSCURO ===
      const darkModeToggle = document.getElementById("darkModeToggle");

      // Cargar preferencia guardada
      if (localStorage.getItem("darkMode") === "enabled") {
        document.body.classList.add("dark-mode");
        darkModeToggle.checked = true;
      }

      // Toggle dark mode
      darkModeToggle.addEventListener("change", function () {
        if (this.checked) {
          document.body.classList.add("dark-mode");
          localStorage.setItem("darkMode", "enabled");
        } else {
          document.body.classList.remove("dark-mode");
          localStorage.setItem("darkMode", "disabled");
        }
      });

      // === WEB AUDIO API SETUP (funciona en iOS) ===
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      const audioContext = new AudioContext();

      // === EFECTOS DE SONIDO ===
      const soundButtons = document.querySelectorAll(".sound-button");
      const volumeSliders = document.querySelectorAll(".volume-slider");
      const audioCache = {};
      const gainNodes = {};

      // Pre-cargar efectos de sonido
      soundButtons.forEach((button) => {
        const soundNum = button.dataset.sound;

        // Crear nodo de ganancia (volumen) para cada sonido
        gainNodes[soundNum] = audioContext.createGain();
        gainNodes[soundNum].connect(audioContext.destination);

        // Cargar volumen guardado o usar 100% por defecto
        const savedVolume = localStorage.getItem(`sound${soundNum}Volume`);
        const volumeValue =
          savedVolume !== null ? parseFloat(savedVolume) : 1.0;
        gainNodes[soundNum].gain.value = volumeValue;

        // Cargar audio
        fetch(`sound${soundNum}.mp3`)
          .then((response) => response.arrayBuffer())
          .then((arrayBuffer) => audioContext.decodeAudioData(arrayBuffer))
          .then((audioBuffer) => {
            audioCache[soundNum] = audioBuffer;
          })
          .catch((err) =>
            console.error(`Error cargando sound${soundNum}.mp3:`, err)
          );
      });

      // Restaurar valores de volumen en los sliders
      volumeSliders.forEach((slider) => {
        const soundNum = slider.dataset.sound;
        const savedVolume = localStorage.getItem(`sound${soundNum}Volume`);
        if (savedVolume !== null) {
          const volumePercent = Math.round(parseFloat(savedVolume) * 100);
          slider.value = volumePercent;
          slider.nextElementSibling.textContent = volumePercent + "%";
        }
      });

      // Reproducir efectos
      soundButtons.forEach((button) => {
        button.addEventListener("click", function () {
          // Reanudar contexto de audio si estÃ¡ suspendido (requisito iOS)
          if (audioContext.state === "suspended") {
            audioContext.resume();
          }

          const soundNum = this.dataset.sound;
          const audioBuffer = audioCache[soundNum];

          if (!audioBuffer) {
            alert("No se pudo cargar sound" + soundNum + ".mp3");
            return;
          }

          // Crear source node
          const source = audioContext.createBufferSource();
          source.buffer = audioBuffer;
          source.connect(gainNodes[soundNum]);
          source.start(0);

          this.classList.add("playing");
          setTimeout(() => this.classList.remove("playing"), 500);
        });
      });

      // Control de volumen de efectos
      volumeSliders.forEach((slider) => {
        const soundNum = slider.dataset.sound;
        const valueDisplay = slider.nextElementSibling;

        slider.addEventListener("input", function () {
          const volume = this.value / 100;
          gainNodes[soundNum].gain.value = volume;
          valueDisplay.textContent = this.value + "%";

          // Guardar en localStorage
          localStorage.setItem(`sound${soundNum}Volume`, volume);
        });
      });

      // === MÃšSICA AMBIENTE ===
      const playButtons = document.querySelectorAll(".play-button");
      const trackSliders = document.querySelectorAll(".track-volume-slider");
      const trackCache = {};
      const trackGainNodes = {};
      const trackSources = {};

      // Pre-cargar pistas de ambiente
      playButtons.forEach((button) => {
        const trackNum = button.dataset.track;

        // Crear nodo de ganancia para cada pista
        trackGainNodes[trackNum] = audioContext.createGain();
        trackGainNodes[trackNum].connect(audioContext.destination);

        // Cargar volumen guardado o usar 50% por defecto
        const savedVolume = localStorage.getItem(`track${trackNum}Volume`);
        const volumeValue =
          savedVolume !== null ? parseFloat(savedVolume) : 0.5;
        trackGainNodes[trackNum].gain.value = volumeValue;

        // Inicializar tracking
        trackSources[trackNum] = {
          source: null,
          isPlaying: false,
        };

        // Cargar pista
        fetch(`track${trackNum}.mp3`)
          .then((response) => response.arrayBuffer())
          .then((arrayBuffer) => audioContext.decodeAudioData(arrayBuffer))
          .then((audioBuffer) => {
            trackCache[trackNum] = audioBuffer;
          })
          .catch((err) =>
            console.error(`Error cargando track${trackNum}.mp3:`, err)
          );
      });

      // Restaurar valores de volumen en los sliders de pistas
      trackSliders.forEach((slider) => {
        const trackNum = slider.dataset.track;
        const savedVolume = localStorage.getItem(`track${trackNum}Volume`);
        if (savedVolume !== null) {
          const volumePercent = Math.round(parseFloat(savedVolume) * 100);
          slider.value = volumePercent;
          slider.nextElementSibling.textContent = volumePercent + "%";
        }
      });

      // Play/Stop de pistas (toggle)
      playButtons.forEach((button) => {
        button.addEventListener("click", function () {
          // Reanudar contexto de audio si estÃ¡ suspendido
          if (audioContext.state === "suspended") {
            audioContext.resume();
          }

          const trackNum = this.dataset.track;
          const audioBuffer = trackCache[trackNum];
          const trackState = trackSources[trackNum];

          if (!audioBuffer) {
            alert("No se pudo cargar track" + trackNum + ".mp3");
            return;
          }

          // Si estÃ¡ sonando, STOP (detener y resetear)
          if (trackState.isPlaying) {
            trackState.source.stop();
            trackState.isPlaying = false;

            this.classList.remove("playing");
            this.textContent = "â–¶";
            localStorage.setItem(`track${trackNum}Playing`, "false");
            return;
          }

          // Si estÃ¡ detenido, PLAY (empezar desde el inicio)
          const source = audioContext.createBufferSource();
          source.buffer = audioBuffer;
          source.loop = true;
          source.connect(trackGainNodes[trackNum]);
          source.start(0);

          trackState.source = source;
          trackState.isPlaying = true;

          this.classList.add("playing");
          this.textContent = "â¹";
          localStorage.setItem(`track${trackNum}Playing`, "true");
        });
      });

      // Control de volumen de pistas
      trackSliders.forEach((slider) => {
        const trackNum = slider.dataset.track;
        const valueDisplay = slider.nextElementSibling;

        slider.addEventListener("input", function () {
          const volume = this.value / 100;
          trackGainNodes[trackNum].gain.value = volume;
          valueDisplay.textContent = this.value + "%";

          // Guardar en localStorage
          localStorage.setItem(`track${trackNum}Volume`, volume);
        });
      });

      // === LOG DE ESTADOS GUARDADOS ===
      console.log(
        "âœ… Todos los estados se guardan automÃ¡ticamente en localStorage"
      );
      console.log("ğŸ¨ Modo oscuro:", localStorage.getItem("darkMode"));
      console.log("ğŸ“Š VolÃºmenes guardados:");
      for (let i = 1; i <= 12; i++) {
        const vol = localStorage.getItem(`sound${i}Volume`);
        if (vol) console.log(`  Sound ${i}: ${Math.round(vol * 100)}%`);
      }
      for (let i = 1; i <= 2; i++) {
        const vol = localStorage.getItem(`track${i}Volume`);
        if (vol) console.log(`  Track ${i}: ${Math.round(vol * 100)}%`);
      }
    </script>
  </body>
</html>
